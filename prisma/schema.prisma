generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  password  String?
  image     String?
  provider  String?   // google, kakao, credentials
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
}

model Project {
  id             String        @id @default(uuid())
  title          String
  type           String
  description    String
  status         String        @default("draft")
  stage          String        @default("research") // research, outline, write, edit, review
  outline        String?       // JSON stored as string
  bible          String?       // JSON: BookBible 객체 (Fiction/SelfHelp)
  targetAudience String?
  targetLength   Int?          // 목표 페이지 수
  tone           String?       // 문체/어투
  confirmedAt    DateTime?     // 목차 확정 시간
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  chapters       Chapter[]
  coverImage     CoverImage?
  researchData   ResearchData?
  editHistory    EditHistory[]
  sourceFile     SourceFile?
  bookMetadata   BookMetadata?
  isbn           ISBN?
  memos          Memo[]
  sources        Source[]
}

model SourceFile {
  id         String   @id @default(uuid())
  projectId  String   @unique
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fileName   String
  fileType   String   // 'txt' | 'docx' | 'pdf'
  fileSize   Int
  rawContent String   // 원본 텍스트 전체
  createdAt  DateTime @default(now())
}

model ResearchData {
  id          String   @id @default(uuid())
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  initialIdea String   // 초기 아이디어
  aiQuestions String   // JSON: AI가 생성한 질문들
  userAnswers String   // JSON: 사용자 답변들
  findings    String   // JSON: 리서치 결과
  references  String   // JSON: 참고 자료
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EditHistory {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  chapterId     String?
  type          String   // suggestion, revision, approval, rejection
  agent         String   // editor, critic, editor-critic
  beforeContent String?
  afterContent  String
  feedback      String?
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@index([chapterId])
}

model Chapter {
  id        String   @id @default(uuid())
  number    Int
  title     String
  content   String
  status    String   @default("pending")
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pages     Page[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, number])
}

model Page {
  id         String   @id @default(uuid())
  chapterId  String
  chapter    Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  pageNumber Int
  content    String
  status     String   @default("empty") // empty, draft, complete
  wordCount  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([chapterId, pageNumber])
  @@index([chapterId])
}

model CoverImage {
  id        String   @id @default(uuid())
  projectId String   @unique
  imageUrl  String
  prompt    String?
  template  String?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 출판 메타데이터
model BookMetadata {
  id              String    @id @default(uuid())
  projectId       String    @unique
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  subtitle        String?
  authors         String    @default("[]") // JSON: [{name, role, bio}]
  publisher       String?
  publisherAddress String?
  publishDate     DateTime?
  edition         String?   // "초판", "개정판" 등
  printRun        Int?      // 인쇄 부수

  categories      String    @default("[]") // JSON: BISAC/KDC 코드
  keywords        String    @default("[]") // JSON array
  language        String    @default("ko")

  copyright       String?
  license         String?   // CC-BY 등

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ISBN 관리
model ISBN {
  id          String    @id @default(uuid())
  projectId   String    @unique
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  isbn13      String    @unique
  isbn10      String?
  checkDigit  String
  prefix      String    // 978 또는 979
  groupCode   String    // 국가/언어 그룹 (한국: 89)
  registrant  String    // 출판사 코드
  publication String    // 도서 코드

  barcodeUrl  String?   // 생성된 바코드 이미지 URL
  isValid     Boolean   @default(false)
  assignedAt  DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// 메모 기능
model Memo {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  content       String
  chapterNumber Int?     // 특정 챕터 연결 (선택)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([projectId])
}

// 출처 관리
model Source {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title     String
  author    String?
  url       String?
  type      String   // book, article, website, other
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

// AI 채팅 메시지 히스토리
model ChatMessage {
  id          String   @id @default(uuid())
  projectId   String
  chapterId   String?
  pageNumber  Int?
  role        String   // user, assistant
  content     String
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@index([chapterId])
  @@index([projectId, chapterId])
}
